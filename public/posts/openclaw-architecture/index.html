<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OpenClaw 架构深潜：打造生产级个人 AI 助手网关 | Lumi's Tech Blog</title><meta name=keywords content="AI,OpenClaw,Architecture,Gateway"><meta name=description content="拆解 OpenClaw Gateway 的消息流、工具桥、扩展插件与多端同步策略，帮助自建 AI 助手的工程师掌握生产级架构要点。"><meta name=author content="Lumi"><link rel=canonical href=https://Lumicreator.github.io/lumi-tech-blog/posts/openclaw-architecture/><link crossorigin=anonymous href=/lumi-tech-blog/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css integrity="sha256-2jIR5e+Ge/K3X9WmUVz+1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as=style><link rel=icon href=https://Lumicreator.github.io/lumi-tech-blog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://Lumicreator.github.io/lumi-tech-blog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://Lumicreator.github.io/lumi-tech-blog/favicon-32x32.png><link rel=apple-touch-icon href=https://Lumicreator.github.io/lumi-tech-blog/apple-touch-icon.png><link rel=mask-icon href=https://Lumicreator.github.io/lumi-tech-blog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://Lumicreator.github.io/lumi-tech-blog/posts/openclaw-architecture/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><link rel=stylesheet href=/lumi-tech-blog/css/custom.css><style>.post-content,.entry-content,.post-description,p,li{text-align:left;text-justify:auto;word-spacing:normal;letter-spacing:normal;overflow-wrap:break-word;word-break:break-word;hyphens:none}.post-content code,.entry-content code,.post-content a,.entry-content a{letter-spacing:normal;word-spacing:normal}</style><meta property="og:url" content="https://Lumicreator.github.io/lumi-tech-blog/posts/openclaw-architecture/"><meta property="og:site_name" content="Lumi's Tech Blog"><meta property="og:title" content="OpenClaw 架构深潜：打造生产级个人 AI 助手网关"><meta property="og:description" content="拆解 OpenClaw Gateway 的消息流、工具桥、扩展插件与多端同步策略，帮助自建 AI 助手的工程师掌握生产级架构要点。"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-02-01T16:40:00+08:00"><meta property="article:modified_time" content="2026-02-01T16:40:00+08:00"><meta property="article:tag" content="AI"><meta property="article:tag" content="OpenClaw"><meta property="article:tag" content="Architecture"><meta property="article:tag" content="Gateway"><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenClaw 架构深潜：打造生产级个人 AI 助手网关"><meta name=twitter:description content="拆解 OpenClaw Gateway 的消息流、工具桥、扩展插件与多端同步策略，帮助自建 AI 助手的工程师掌握生产级架构要点。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://Lumicreator.github.io/lumi-tech-blog/posts/"},{"@type":"ListItem","position":2,"name":"OpenClaw 架构深潜：打造生产级个人 AI 助手网关","item":"https://Lumicreator.github.io/lumi-tech-blog/posts/openclaw-architecture/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OpenClaw 架构深潜：打造生产级个人 AI 助手网关","name":"OpenClaw 架构深潜：打造生产级个人 AI 助手网关","description":"拆解 OpenClaw Gateway 的消息流、工具桥、扩展插件与多端同步策略，帮助自建 AI 助手的工程师掌握生产级架构要点。","keywords":["AI","OpenClaw","Architecture","Gateway"],"articleBody":"OpenClaw 架构深潜：打造生产级个人 AI 助手网关 “EXFOLIATE! EXFOLIATE!” — 太空龙虾 Molty\n引言 OpenClaw 是一个开源的个人 AI 助手框架，它将现代大型语言模型与人们日常使用的消息渠道无缝连接——WhatsApp、Telegram、Slack、Discord、Signal、iMessage 等。与云托管的 AI 助手不同，OpenClaw 运行在您自己的基础设施上，让您完全掌控数据、会话和工具执行。\n本文为高级开发者和架构师提供 OpenClaw 系统的全面架构分析，帮助您理解如何构建、部署和扩展生产级 AI 助手基础设施。\n代码仓库：github.com/openclaw/openclaw\n目录 高层架构 核心组件 网关（控制平面） Agent 运行时 会话 渠道 技能 节点 通信协议 运行时工作流程 多 Agent 架构 安全模型 可扩展性 部署模式 CLI 参考 最佳实践 核心要点 未来路线图 高层架构 OpenClaw 采用以网关为中心的架构，由单个长期运行的进程管理所有渠道连接，并作为客户端、工具和自动化的控制平面。\ngraph TD subgraph Channels [消息渠道] WA[WhatsApp] TG[Telegram] DC[Discord] SL[Slack] IM[iMessage] end subgraph Gateway [OpenClaw Gateway 控制平面] direction TB Router[Agent 路由器] SessionMgr[会话管理器] ToolExec[工具执行器] Cron[定时调度器] Canvas[Canvas 主机] Router --- SessionMgr SessionMgr --- ToolExec end subgraph Clients [客户端与节点] CLI[CLI 命令行] App[macOS 菜单栏应用] Nodes[设备节点 iOS/Android] end Channels ==\u003e Gateway Gateway \u003c==\u003e Clients ToolExec -.-\u003e Sandbox[Docker 沙箱] 核心设计原则 单一事实来源：每台主机一个网关实例，独占所有渠道会话（这对 WhatsApp 的单会话限制尤为关键） 默认本地回环：网关默认绑定至 127.0.0.1:18789，远程访问需显式配置 协议优先：所有通信采用带 JSON Schema 验证的类型化 WebSocket 协议 确定性路由：响应消息确定性地返回至来源渠道，无需模型参与路由决策 本地优先：专为个人使用设计，会话状态持久化存储于本地 核心组件 网关（控制平面） 网关是 OpenClaw 的核心——一个 Node.js 进程，负责：\n管理所有渠道连接（WhatsApp 通过 Baileys、Telegram 通过 grammY 等） 暴露 WebSocket API 供客户端、自动化和设备节点使用 路由消息 在渠道和 Agent 之间 管理会话状态 和持久化 执行工具（在主机或 Docker 沙箱中） 启动网关 # 基本启动 openclaw gateway --port 18789 # 启用详细日志 openclaw gateway --port 18789 --verbose # 强制终止现有监听并启动 openclaw gateway --force # 开发模式（隔离状态） openclaw --dev gateway --allow-unconfigured 配置文件位置 ~/.openclaw/openclaw.json # 主配置（JSON5 格式） ~/.openclaw/workspace # Agent 工作区 ~/.openclaw/credentials # 渠道凭证 ~/.openclaw/agents/ # 每个 Agent 的状态 最小配置示例 // ~/.openclaw/openclaw.json { agent: { model: \"anthropic/claude-opus-4-5\" }, agents: { defaults: { workspace: \"~/.openclaw/workspace\" } }, channels: { whatsapp: { dmPolicy: \"allowlist\", allowFrom: [\"+15551234567\"] } } } 网关支持通过文件系统监听实现配置热重载。默认模式（gateway.reload.mode=\"hybrid\"）会热应用安全变更，并在关键变更时触发重启。\nAgent 运行时 OpenClaw 使用 Pi 作为其内嵌 Agent 运行时。Agent 循环处理：\n从渠道接收消息 组装上下文（系统提示、技能、会话历史） 通过配置的提供商进行模型推理 带流式输出的工具执行 将会话持久化至 JSONL 格式的记录文件 Agent 循环生命周期 sequenceDiagram participant Ch as 渠道 participant G as 网关 participant A as Agent (Pi) participant M as 模型 participant T as 工具/沙箱 Ch-\u003e\u003eG: 接收入站消息 G-\u003e\u003eG: 解析会话 \u0026 路由 G-\u003e\u003eA: 启动 Agent 轮次 A-\u003e\u003eM: 携带上下文进行推理 M--\u003e\u003eA: 吐出思考流 A--\u003e\u003eG: 实时流式转发给用户 opt 工具调用 M-\u003e\u003eA: 请求执行工具 A-\u003e\u003eT: 执行命令 T--\u003e\u003eA: 返回执行结果 A-\u003e\u003eM: 将结果喂回模型 M--\u003e\u003eA: 最终总结 end A-\u003e\u003eG: 任务完成 G-\u003e\u003eCh: 发送最终响应 G-\u003e\u003eG: 持久化会话记录 关键事件类型 流 用途 lifecycle 阶段转换（start、end、error） assistant 流式模型输出增量 tool 工具开始/更新/结束事件 compaction 会话压缩事件 并发控制 每个会话的运行通过队列系统串行化。这可以防止工具/会话竞态条件，并保持历史记录一致性。消息渠道可配置队列模式：\ncollect：批量收集多条消息 steer：优先级路由 followup：链式响应 会话 会话跟踪用户与 Agent 之间的对话状态。OpenClaw 采用精细的会话模型：\n会话键结构 # 私聊（默认：合并至主会话） agent:: # 按对端隔离 agent::dm: # 按渠道-对端隔离 agent:::dm: # 群组（始终隔离） agent:::group: # Telegram 论坛主题 agent::telegram:group::topic: # 自动化 cron: hook: 会话配置 { session: { // 私聊分组方式 dmScope: \"main\", // 选项：main, per-peer, per-channel-peer // 重置策略 reset: { mode: \"daily\", atHour: 4, // 本地时间凌晨 4 点 idleMinutes: 120 // 或基于空闲时间 }, // 按类型覆盖 resetByType: { dm: { mode: \"idle\", idleMinutes: 240 }, group: { mode: \"daily\", atHour: 4 } }, // 身份关联（跨渠道识别同一用户） identityLinks: { alice: [\"telegram:123456789\", \"discord:987654321012345678\"] } } } 存储布局 ~/.openclaw/agents// ├── sessions/ │ ├── sessions.json # 会话元数据存储 │ ├── .jsonl # 记录日志 │ └── -topic-.jsonl └── agent/ └── auth-profiles.json # 每个 Agent 的模型凭证 渠道 渠道是 OpenClaw 连接的消息平台。每个渠道都有独立的适配器：\n渠道 库 特性 WhatsApp Baileys Web 协议、多账号、媒体 Telegram grammY Bot API、Webhooks、群组、主题 Discord discord.js 服务器、私聊、帖子 Slack Bolt 工作区、频道、帖子 Signal signal-cli 端到端加密 iMessage imsg (macOS) 原生 macOS 集成 WebChat 内置 基于浏览器的界面 渠道配置模式 { channels: { whatsapp: { enabled: true, dmPolicy: \"pairing\", // pairing, allowlist, open allowFrom: [\"+15551234567\"], groups: { \"*\": { requireMention: true } } }, telegram: { enabled: true, botToken: \"${TELEGRAM_BOT_TOKEN}\", dmPolicy: \"pairing\", groups: { \"*\": { requireMention: true } } } } } 私聊策略 策略 行为 pairing 未知发送者将收到配对码以供审批 allowlist 仅 allowFrom 中的号码/ID 可发送消息 open 任何人都可发送消息（对工具执行存在风险！） 技能 技能教会 Agent 如何使用工具。OpenClaw 采用与 AgentSkills 兼容的格式：\n技能结构 skills/ └── my-skill/ └── SKILL.md SKILL.md 格式 --- name: weather description: 获取指定位置的天气预报 --- ## 使用方法 使用 `weather` 命令获取当前天气状况和预报。 ## 示例 `weather \"San Francisco, CA\"` 技能优先级 工作区技能：/skills（最高优先级） 托管技能：~/.openclaw/skills 内置技能：随 OpenClaw 一起发布（最低优先级） 技能门控 技能可根据环境、二进制文件或配置条件加载：\n# SKILL.md frontmatter --- name: macos-only-skill description: 需要 macOS 环境 metadata: {\"openclaw\":{\"requires\":{\"platform\":\"darwin\",\"bins\":[\"swift\"]}}} --- 节点 节点是连接到网关的远程设备（macOS、iOS、Android），用于执行设备本地操作：\n节点能力 命令 描述 canvas.* 渲染 Agent 驱动的 UI camera.* 拍照、录制视频 screen.record 屏幕录制 location.get 获取设备位置 system.notify 推送通知 system.run 执行命令（macOS） 节点架构 ┌────────────────┐ WebSocket ┌──────────────┐ │ 网关 │◄──────────────────►│ macOS 节点 │ │ │ │ - 相机 │ │ node.invoke │ │ - 屏幕 │ │ node.list │ │ - 位置 │ │ node.describe │ │ - system.* │ └────────────────┘ └──────────────┘ ▲ │ ▼ ┌────────────────┐ │ iOS 节点 │ │ - Canvas │ │ - 相机 │ │ - 语音 │ └────────────────┘ 节点配对流程 节点在 connect 帧中携带 role: \"node\" 进行连接 网关为未识别的设备返回配对码 操作员审批：openclaw pairing approve 节点收到设备令牌，用于后续连接 通信协议 OpenClaw 使用带强制握手的类型化 WebSocket 协议：\n连接生命周期 客户端 网关 │ │ │── req:connect ────────────────►│ │ │ (验证认证、能力) │◄────────── res:hello-ok ───────│ │ │ │◄────────── event:presence ─────│ │◄────────── event:tick ─────────│ │ │ │── req:agent ──────────────────►│ │◄────────── res:ack ────────────│ (runId, status:accepted) │◄────────── event:agent ────────│ (流式传输) │◄────────── res:agent ──────────│ (最终：status, summary) │ │ 消息类型 // 请求 { type: \"req\", id: string, method: string, params: object } // 响应 { type: \"res\", id: string, ok: boolean, payload?: object, error?: object } // 事件 { type: \"event\", event: string, payload: object, seq?: number, stateVersion?: number } 核心方法 方法 用途 connect 强制首帧，建立会话 agent 运行一轮 Agent agent.wait 等待 Agent 完成 send 通过活动渠道发送消息 health 完整健康快照 status 简短摘要 node.list 列出已连接/已配对的节点 node.invoke 执行节点命令 config.patch 部分配置更新 + 重启 认证 // 带认证的连接帧 { type: \"req\", id: \"1\", method: \"connect\", params: { minProtocol: 1, maxProtocol: 1, client: { id: \"my-client-id\", version: \"1.0.0\", platform: \"macos\" }, auth: { token: \"${OPENCLAW_GATEWAY_TOKEN}\" // 非本地回环连接必需 } } } 运行时工作流程 消息流：从接收到响应 1. 消息接收（WhatsApp/Telegram 等） │ ▼ 2. 渠道适配器规范化信封 - 提取发送者、内容、媒体、回复上下文 │ ▼ 3. 路由确定 Agent 和会话 - 检查多 Agent 绑定 - 应用私聊策略（pairing/allowlist/open） - 构建会话键 │ ▼ 4. 会话管理器加载/创建会话 - 检查重置策略（daily/idle） - 加载现有记录（如存在） │ ▼ 5. Agent 循环执行 - 组装系统提示 + 技能 - 携带上下文调用模型 - 按需执行工具 - 流式输出助手响应 │ ▼ 6. 响应路由发送回复 - 确定性：返回源渠道 - 按平台限制分块 - 处理媒体附件 │ ▼ 7. 会话持久化记录至 JSONL 工具执行流程 stateDiagram-v2 [*] --\u003e Request: 模型发起工具调用 Request --\u003e SandboxCheck: 检查沙箱模式 state SandboxCheck { direction LR Host: 在宿主机运行 Docker: 在 Docker 沙箱运行 } SandboxCheck --\u003e Host: mode=\"off\" SandboxCheck --\u003e Docker: mode=\"all\" | mode=\"non-main\" Host --\u003e Sanitize: 获取执行结果 Docker --\u003e Sanitize: 获取执行结果 Sanitize --\u003e Stream: 脱敏并实时推流 Stream --\u003e [*]: 完成并喂回模型 多 Agent 架构 OpenClaw 支持在单个网关内运行多个隔离的 Agent：\nAgent 隔离 每个 Agent 拥有：\n独立工作区（文件、AGENTS.md、SOUL.md、USER.md） 独立状态目录（~/.openclaw/agents/） 独立会话存储 独立认证配置（模型凭证） 绑定配置 { agents: { list: [ { id: \"personal\", workspace: \"~/.openclaw/workspace-personal\", default: true }, { id: \"work\", workspace: \"~/.openclaw/workspace-work\" } ] }, bindings: [ // 将特定私聊路由至工作 Agent { agentId: \"work\", match: { channel: \"telegram\", peer: { kind: \"dm\", id: \"123456789\" } } }, // 将 Discord 服务器路由至工作 Agent { agentId: \"work\", match: { channel: \"discord\", guildId: \"987654321\" } } // 其他流量回落至默认（personal） ] } 绑定解析顺序 精确对端匹配（私聊/群组/频道 ID） 服务器 ID（Discord） 团队 ID（Slack） 渠道账号 ID 渠道级匹配 默认 Agent 安全模型 威胁模型 运行具有 Shell 访问权限的 AI 助手需要谨慎的安全设计：\n┌────────────────────────────────────────────────────────────┐ │ 威胁面 │ │ │ │ 入站攻击 │ │ - 消息中的提示注入 │ │ - 通过私聊进行社会工程 │ │ - 恶意群组成员 │ │ │ │ 影响范围 │ │ - Shell 命令执行 │ │ - 文件系统访问 │ │ - 网络访问 │ │ - 凭证暴露 │ └────────────────────────────────────────────────────────────┘ 防御层级 身份优先：控制谁可以与机器人对话 范围次之：限制机器人的操作范围 沙箱隔离：隔离工具执行环境 工具策略：允许/拒绝特定工具 安全审计 # 运行安全审计 openclaw security audit # 深度审计（包含实时探测） openclaw security audit --deep # 自动修复常见问题 openclaw security audit --fix 沙箱配置 { agents: { defaults: { sandbox: { mode: \"non-main\", // off, non-main, all scope: \"session\", // session, agent, shared workspaceAccess: \"none\", // none, ro, rw docker: { network: \"none\", // 禁用网络 binds: [ // 自定义挂载 \"/data/shared:/data:ro\" ] } } } } } 凭证存储 凭证 位置 WhatsApp 凭证 ~/.openclaw/credentials/whatsapp//creds.json Telegram 令牌 配置文件或环境变量 模型认证 ~/.openclaw/agents//agent/auth-profiles.json 配对白名单 ~/.openclaw/credentials/-allowFrom.json 可扩展性 插件系统 插件通过新渠道、工具和技能扩展 OpenClaw：\n# 列出插件 openclaw plugins list # 安装插件 openclaw plugins install # 启用/禁用 openclaw plugins enable openclaw plugins disable 插件钩子 钩子 时机 before_agent_start Agent 轮次开始前 agent_end Agent 完成后 before_tool_call 工具执行前 after_tool_call 工具执行后 message_received 接收入站消息 message_sending 发送前 gateway_start 网关启动 ClawdHub（技能注册中心） ClawdHub 提供技能发现和安装：\n# 安装技能 clawdhub install weather # 更新所有技能 clawdhub update --all # 同步本地技能至注册中心 clawdhub sync --all 部署模式 模式 1：本地开发 # 快速开始 npm install -g openclaw@latest openclaw onboard --install-daemon openclaw channels login # WhatsApp 扫码 openclaw gateway 模式 2：远程 Linux 服务器 # 在服务器上 npm install -g openclaw@latest openclaw onboard --install-daemon # 通过 SSH 隧道访问 ssh -N -L 18789:127.0.0.1:18789 user@server 模式 3：Docker 部署 # 构建和设置 ./docker-setup.sh # 手动 compose docker build -t openclaw:local -f Dockerfile . docker compose run --rm openclaw-cli onboard docker compose up -d openclaw-gateway 模式 4：Tailscale 暴露 { gateway: { tailscale: { mode: \"serve\", // serve（内网）或 funnel（公网） resetOnExit: true }, auth: { mode: \"password\", // funnel 必需 password: \"${OPENCLAW_GATEWAY_PASSWORD}\" } } } 模式 5：多 Agent 服务器 { agents: { list: [ { id: \"alice\", workspace: \"~/.openclaw/workspace-alice\" }, { id: \"bob\", workspace: \"~/.openclaw/workspace-bob\" } ] }, channels: { whatsapp: { accounts: [ { id: \"alice-wa\", name: \"Alice\" }, { id: \"bob-wa\", name: \"Bob\" } ] } }, bindings: [ { agentId: \"alice\", match: { channel: \"whatsapp\", accountId: \"alice-wa\" } }, { agentId: \"bob\", match: { channel: \"whatsapp\", accountId: \"bob-wa\" } } ] } CLI 参考 常用命令 # 设置与配置 openclaw onboard # 交互式向导 openclaw setup # 初始化配置 openclaw configure # 设置凭证 openclaw doctor # 健康检查 + 修复 # 网关控制 openclaw gateway status # 检查网关状态 openclaw gateway start # 作为服务启动 openclaw gateway stop # 停止服务 openclaw gateway restart # 重启服务 openclaw gateway --port 18789 # 前台运行 # 消息 openclaw message send --target +1234567890 --message \"Hello\" openclaw agent --message \"今天天气怎么样？\" --thinking high # 会话 openclaw sessions # 列出会话 openclaw sessions --json # JSON 输出 openclaw status # 快速健康检查 # 渠道 openclaw channels list # 列出已配置渠道 openclaw channels login # 关联 WhatsApp 等 openclaw channels status # 渠道健康状况 # 技能 openclaw skills list # 列出已加载技能 openclaw skills info # 技能详情 # 安全 openclaw security audit # 运行安全审计 应用内聊天命令 命令 操作 /status 会话状态、token 数、模型 /new 或 /reset 重置会话 /new 使用新模型重置 /compact 压缩旧上下文 /think 设置思考级别 /stop 中止当前运行 /context list 显示上下文来源 /send on/off 切换消息发送 最佳实践 1. 安全优先 { channels: { whatsapp: { dmPolicy: \"pairing\", // 切勿使用 \"open\"！ groups: { \"*\": { requireMention: true } } } }, agents: { defaults: { sandbox: { mode: \"non-main\" } // 群组使用沙箱 } } } 2. 使用专用手机号 对于 WhatsApp，建议使用独立号码以避免自聊天的异常行为，并保持路由清晰。\n3. 工作区组织 ~/.openclaw/workspace/ ├── AGENTS.md # Agent 指令 ├── SOUL.md # 人格定义 ├── USER.md # 用户上下文 ├── TOOLS.md # 环境特定笔记 ├── memory/ │ └── YYYY-MM-DD.md # 每日日志 ├── skills/ │ └── custom-skill/ │ └── SKILL.md └── canvas/ └── index.html # Canvas 内容 4. 模型选择 { agent: { model: \"anthropic/claude-opus-4-5\", // 强大的长上下文能力 thinkingLevel: \"low\" // 平衡速度与质量 } } 5. 会话重置策略 { session: { reset: { mode: \"daily\", atHour: 4 // 每天早晨全新开始 }, resetByType: { group: { mode: \"idle\", idleMinutes: 120 } // 群组更快重置 } } } 6. 监控 # 定期检查健康状况 openclaw health # 监控日志 openclaw logs --follow # 定期运行审计 openclaw doctor openclaw security audit 核心要点 以网关为中心的设计：单一进程管理所有渠道连接，实现确定性路由和一致的状态管理。\n协议优先通信：带 JSON Schema 验证的类型化 WebSocket 协议确保可靠的客户端-服务器交互。\n分层安全：身份控制 → 范围限制 → 沙箱隔离 → 工具策略，提供纵深防御。\n灵活的多 Agent：绑定机制将消息路由至隔离的 Agent，支持在共享基础设施上运行多个用户或角色。\n可扩展架构：技能、插件和钩子支持在不修改核心代码的情况下进行定制。\n生产就绪运维：systemd/launchd 集成、热重载、健康检查和安全审计支持可靠部署。\n未来路线图 基于当前开发模式和文档，潜在的演进方向包括：\n近期 增强 MCP 支持：更深入的模型上下文协议集成 语音通话技能：实时语音对话支持 改进沙箱浏览器：沙箱环境中更好的浏览器自动化 中期 联邦：跨网关 Agent 通信 插件市场：策划的插件生态系统 企业功能：SSO、审计日志、合规工具 长期 分布式网关：多节点网关实现高可用 微调集成：自定义模型训练工作流 Agent 间协议：标准化的多 Agent 协作 结语 OpenClaw 代表了一种精心设计的个人 AI 助手方案——优先考虑本地控制、安全性和可扩展性。其以网关为中心的架构为将 LLM 与真实世界消息系统集成提供了坚实基础，同时保持了运维的简洁性。\n对于构建生产级 AI 助手基础设施的开发者而言，OpenClaw 提供了宝贵的模式：协议驱动的通信、纵深防御的安全性，以及渠道、Agent 和工具之间的清晰分离。\n开始使用：github.com/openclaw/openclaw\n文档：docs.openclaw.ai\n社区：Discord\n本文通过分析 OpenClaw 代码仓库（项目根目录）和 https://github.com/openclaw/openclaw（版本 2026.1.29）生成。\n","wordCount":"1710","inLanguage":"en","datePublished":"2026-02-01T16:40:00+08:00","dateModified":"2026-02-01T16:40:00+08:00","author":{"@type":"Person","name":"Lumi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://Lumicreator.github.io/lumi-tech-blog/posts/openclaw-architecture/"},"publisher":{"@type":"Organization","name":"Lumi's Tech Blog","logo":{"@type":"ImageObject","url":"https://Lumicreator.github.io/lumi-tech-blog/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://Lumicreator.github.io/lumi-tech-blog/ accesskey=h title="Lumi's Tech Blog (Alt + H)">Lumi's Tech Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://Lumicreator.github.io/lumi-tech-blog/posts/ title=文章><span>文章</span></a></li><li><a href=https://Lumicreator.github.io/lumi-tech-blog/categories/ title=分类><span>分类</span></a></li><li><a href=https://Lumicreator.github.io/lumi-tech-blog/tags/ title=标签><span>标签</span></a></li><li><a href=https://Lumicreator.github.io/lumi-tech-blog/search/ title=搜索><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://Lumicreator.github.io/lumi-tech-blog/>Home</a>&nbsp;»&nbsp;<a href=https://Lumicreator.github.io/lumi-tech-blog/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">OpenClaw 架构深潜：打造生产级个人 AI 助手网关</h1><div class=post-description>拆解 OpenClaw Gateway 的消息流、工具桥、扩展插件与多端同步策略，帮助自建 AI 助手的工程师掌握生产级架构要点。</div><div class=post-meta><span title='2026-02-01 16:40:00 +0800 +0800'>February 1, 2026</span>&nbsp;·&nbsp;<span>9 min</span>&nbsp;·&nbsp;<span>Lumi</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#openclaw-%e6%9e%b6%e6%9e%84%e6%b7%b1%e6%bd%9c%e6%89%93%e9%80%a0%e7%94%9f%e4%ba%a7%e7%ba%a7%e4%b8%aa%e4%ba%ba-ai-%e5%8a%a9%e6%89%8b%e7%bd%91%e5%85%b3 aria-label="OpenClaw 架构深潜：打造生产级个人 AI 助手网关">OpenClaw 架构深潜：打造生产级个人 AI 助手网关</a><ul><li><a href=#%e5%bc%95%e8%a8%80 aria-label=引言>引言</a></li><li><a href=#%e7%9b%ae%e5%bd%95 aria-label=目录>目录</a></li><li><a href=#%e9%ab%98%e5%b1%82%e6%9e%b6%e6%9e%84 aria-label=高层架构>高层架构</a><ul><li><a href=#%e6%a0%b8%e5%bf%83%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99 aria-label=核心设计原则>核心设计原则</a></li></ul></li><li><a href=#%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6 aria-label=核心组件>核心组件</a><ul><li><a href=#%e7%bd%91%e5%85%b3%e6%8e%a7%e5%88%b6%e5%b9%b3%e9%9d%a2 aria-label=网关（控制平面）>网关（控制平面）</a><ul><li><a href=#%e5%90%af%e5%8a%a8%e7%bd%91%e5%85%b3 aria-label=启动网关>启动网关</a></li><li><a href=#%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e4%bd%8d%e7%bd%ae aria-label=配置文件位置>配置文件位置</a></li><li><a href=#%e6%9c%80%e5%b0%8f%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b aria-label=最小配置示例>最小配置示例</a></li></ul></li><li><a href=#agent-%e8%bf%90%e8%a1%8c%e6%97%b6 aria-label="Agent 运行时">Agent 运行时</a><ul><li><a href=#agent-%e5%be%aa%e7%8e%af%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f aria-label="Agent 循环生命周期">Agent 循环生命周期</a></li><li><a href=#%e5%85%b3%e9%94%ae%e4%ba%8b%e4%bb%b6%e7%b1%bb%e5%9e%8b aria-label=关键事件类型>关键事件类型</a></li><li><a href=#%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6 aria-label=并发控制>并发控制</a></li></ul></li><li><a href=#%e4%bc%9a%e8%af%9d aria-label=会话>会话</a><ul><li><a href=#%e4%bc%9a%e8%af%9d%e9%94%ae%e7%bb%93%e6%9e%84 aria-label=会话键结构>会话键结构</a></li><li><a href=#%e4%bc%9a%e8%af%9d%e9%85%8d%e7%bd%ae aria-label=会话配置>会话配置</a></li><li><a href=#%e5%ad%98%e5%82%a8%e5%b8%83%e5%b1%80 aria-label=存储布局>存储布局</a></li></ul></li><li><a href=#%e6%b8%a0%e9%81%93 aria-label=渠道>渠道</a><ul><li><a href=#%e6%b8%a0%e9%81%93%e9%85%8d%e7%bd%ae%e6%a8%a1%e5%bc%8f aria-label=渠道配置模式>渠道配置模式</a></li><li><a href=#%e7%a7%81%e8%81%8a%e7%ad%96%e7%95%a5 aria-label=私聊策略>私聊策略</a></li></ul></li><li><a href=#%e6%8a%80%e8%83%bd aria-label=技能>技能</a><ul><li><a href=#%e6%8a%80%e8%83%bd%e7%bb%93%e6%9e%84 aria-label=技能结构>技能结构</a></li><li><a href=#skillmd-%e6%a0%bc%e5%bc%8f aria-label="SKILL.md 格式">SKILL.md 格式</a></li><li><a href=#%e6%8a%80%e8%83%bd%e4%bc%98%e5%85%88%e7%ba%a7 aria-label=技能优先级>技能优先级</a></li><li><a href=#%e6%8a%80%e8%83%bd%e9%97%a8%e6%8e%a7 aria-label=技能门控>技能门控</a></li></ul></li><li><a href=#%e8%8a%82%e7%82%b9 aria-label=节点>节点</a><ul><li><a href=#%e8%8a%82%e7%82%b9%e8%83%bd%e5%8a%9b aria-label=节点能力>节点能力</a></li><li><a href=#%e8%8a%82%e7%82%b9%e6%9e%b6%e6%9e%84 aria-label=节点架构>节点架构</a></li><li><a href=#%e8%8a%82%e7%82%b9%e9%85%8d%e5%af%b9%e6%b5%81%e7%a8%8b aria-label=节点配对流程>节点配对流程</a></li></ul></li></ul></li><li><a href=#%e9%80%9a%e4%bf%a1%e5%8d%8f%e8%ae%ae aria-label=通信协议>通信协议</a><ul><li><a href=#%e8%bf%9e%e6%8e%a5%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f aria-label=连接生命周期>连接生命周期</a></li><li><a href=#%e6%b6%88%e6%81%af%e7%b1%bb%e5%9e%8b aria-label=消息类型>消息类型</a></li><li><a href=#%e6%a0%b8%e5%bf%83%e6%96%b9%e6%b3%95 aria-label=核心方法>核心方法</a></li><li><a href=#%e8%ae%a4%e8%af%81 aria-label=认证>认证</a></li></ul></li><li><a href=#%e8%bf%90%e8%a1%8c%e6%97%b6%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b aria-label=运行时工作流程>运行时工作流程</a><ul><li><a href=#%e6%b6%88%e6%81%af%e6%b5%81%e4%bb%8e%e6%8e%a5%e6%94%b6%e5%88%b0%e5%93%8d%e5%ba%94 aria-label=消息流：从接收到响应>消息流：从接收到响应</a></li><li><a href=#%e5%b7%a5%e5%85%b7%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b aria-label=工具执行流程>工具执行流程</a></li></ul></li><li><a href=#%e5%a4%9a-agent-%e6%9e%b6%e6%9e%84 aria-label="多 Agent 架构">多 Agent 架构</a><ul><li><a href=#agent-%e9%9a%94%e7%a6%bb aria-label="Agent 隔离">Agent 隔离</a></li><li><a href=#%e7%bb%91%e5%ae%9a%e9%85%8d%e7%bd%ae aria-label=绑定配置>绑定配置</a></li><li><a href=#%e7%bb%91%e5%ae%9a%e8%a7%a3%e6%9e%90%e9%a1%ba%e5%ba%8f aria-label=绑定解析顺序>绑定解析顺序</a></li></ul></li><li><a href=#%e5%ae%89%e5%85%a8%e6%a8%a1%e5%9e%8b aria-label=安全模型>安全模型</a><ul><li><a href=#%e5%a8%81%e8%83%81%e6%a8%a1%e5%9e%8b aria-label=威胁模型>威胁模型</a></li><li><a href=#%e9%98%b2%e5%be%a1%e5%b1%82%e7%ba%a7 aria-label=防御层级>防御层级</a></li><li><a href=#%e5%ae%89%e5%85%a8%e5%ae%a1%e8%ae%a1 aria-label=安全审计>安全审计</a></li><li><a href=#%e6%b2%99%e7%ae%b1%e9%85%8d%e7%bd%ae aria-label=沙箱配置>沙箱配置</a></li><li><a href=#%e5%87%ad%e8%af%81%e5%ad%98%e5%82%a8 aria-label=凭证存储>凭证存储</a></li></ul></li><li><a href=#%e5%8f%af%e6%89%a9%e5%b1%95%e6%80%a7 aria-label=可扩展性>可扩展性</a><ul><li><a href=#%e6%8f%92%e4%bb%b6%e7%b3%bb%e7%bb%9f aria-label=插件系统>插件系统</a></li><li><a href=#%e6%8f%92%e4%bb%b6%e9%92%a9%e5%ad%90 aria-label=插件钩子>插件钩子</a></li><li><a href=#clawdhub%e6%8a%80%e8%83%bd%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83 aria-label=ClawdHub（技能注册中心）>ClawdHub（技能注册中心）</a></li></ul></li><li><a href=#%e9%83%a8%e7%bd%b2%e6%a8%a1%e5%bc%8f aria-label=部署模式>部署模式</a><ul><li><a href=#%e6%a8%a1%e5%bc%8f-1%e6%9c%ac%e5%9c%b0%e5%bc%80%e5%8f%91 aria-label="模式 1：本地开发">模式 1：本地开发</a></li><li><a href=#%e6%a8%a1%e5%bc%8f-2%e8%bf%9c%e7%a8%8b-linux-%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label="模式 2：远程 Linux 服务器">模式 2：远程 Linux 服务器</a></li><li><a href=#%e6%a8%a1%e5%bc%8f-3docker-%e9%83%a8%e7%bd%b2 aria-label="模式 3：Docker 部署">模式 3：Docker 部署</a></li><li><a href=#%e6%a8%a1%e5%bc%8f-4tailscale-%e6%9a%b4%e9%9c%b2 aria-label="模式 4：Tailscale 暴露">模式 4：Tailscale 暴露</a></li><li><a href=#%e6%a8%a1%e5%bc%8f-5%e5%a4%9a-agent-%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label="模式 5：多 Agent 服务器">模式 5：多 Agent 服务器</a></li></ul></li><li><a href=#cli-%e5%8f%82%e8%80%83 aria-label="CLI 参考">CLI 参考</a><ul><li><a href=#%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4 aria-label=常用命令>常用命令</a></li><li><a href=#%e5%ba%94%e7%94%a8%e5%86%85%e8%81%8a%e5%a4%a9%e5%91%bd%e4%bb%a4 aria-label=应用内聊天命令>应用内聊天命令</a></li></ul></li><li><a href=#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label=最佳实践>最佳实践</a><ul><li><a href=#1-%e5%ae%89%e5%85%a8%e4%bc%98%e5%85%88 aria-label="1. 安全优先">1. 安全优先</a></li><li><a href=#2-%e4%bd%bf%e7%94%a8%e4%b8%93%e7%94%a8%e6%89%8b%e6%9c%ba%e5%8f%b7 aria-label="2. 使用专用手机号">2. 使用专用手机号</a></li><li><a href=#3-%e5%b7%a5%e4%bd%9c%e5%8c%ba%e7%bb%84%e7%bb%87 aria-label="3. 工作区组织">3. 工作区组织</a></li><li><a href=#4-%e6%a8%a1%e5%9e%8b%e9%80%89%e6%8b%a9 aria-label="4. 模型选择">4. 模型选择</a></li><li><a href=#5-%e4%bc%9a%e8%af%9d%e9%87%8d%e7%bd%ae%e7%ad%96%e7%95%a5 aria-label="5. 会话重置策略">5. 会话重置策略</a></li><li><a href=#6-%e7%9b%91%e6%8e%a7 aria-label="6. 监控">6. 监控</a></li></ul></li><li><a href=#%e6%a0%b8%e5%bf%83%e8%a6%81%e7%82%b9 aria-label=核心要点>核心要点</a></li><li><a href=#%e6%9c%aa%e6%9d%a5%e8%b7%af%e7%ba%bf%e5%9b%be aria-label=未来路线图>未来路线图</a><ul><li><a href=#%e8%bf%91%e6%9c%9f aria-label=近期>近期</a></li><li><a href=#%e4%b8%ad%e6%9c%9f aria-label=中期>中期</a></li><li><a href=#%e9%95%bf%e6%9c%9f aria-label=长期>长期</a></li></ul></li><li><a href=#%e7%bb%93%e8%af%ad aria-label=结语>结语</a></li></ul></li></ul></div></details></div><div class=post-content><h1 id=openclaw-架构深潜打造生产级个人-ai-助手网关>OpenClaw 架构深潜：打造生产级个人 AI 助手网关<a hidden class=anchor aria-hidden=true href=#openclaw-架构深潜打造生产级个人-ai-助手网关>#</a></h1><blockquote><p><em>&ldquo;EXFOLIATE! EXFOLIATE!&rdquo;</em> — 太空龙虾 Molty</p></blockquote><p><img alt=架构图 loading=lazy src=https://Lumicreator.github.io/lumi-tech-blog/openclaw-architecture-main.png></p><h2 id=引言>引言<a hidden class=anchor aria-hidden=true href=#引言>#</a></h2><p>OpenClaw 是一个开源的个人 AI 助手框架，它将现代大型语言模型与人们日常使用的消息渠道无缝连接——WhatsApp、Telegram、Slack、Discord、Signal、iMessage 等。与云托管的 AI 助手不同，OpenClaw 运行在您自己的基础设施上，让您完全掌控数据、会话和工具执行。</p><p>本文为高级开发者和架构师提供 OpenClaw 系统的全面架构分析，帮助您理解如何构建、部署和扩展生产级 AI 助手基础设施。</p><p><strong>代码仓库</strong>：<a href=https://github.com/openclaw/openclaw>github.com/openclaw/openclaw</a></p><hr><h2 id=目录>目录<a hidden class=anchor aria-hidden=true href=#目录>#</a></h2><ol><li><a href=#%E9%AB%98%E5%B1%82%E6%9E%B6%E6%9E%84>高层架构</a></li><li><a href=#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6>核心组件</a><ul><li><a href=#%E7%BD%91%E5%85%B3%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2>网关（控制平面）</a></li><li><a href=#agent-%E8%BF%90%E8%A1%8C%E6%97%B6>Agent 运行时</a></li><li><a href=#%E4%BC%9A%E8%AF%9D>会话</a></li><li><a href=#%E6%B8%A0%E9%81%93>渠道</a></li><li><a href=#%E6%8A%80%E8%83%BD>技能</a></li><li><a href=#%E8%8A%82%E7%82%B9>节点</a></li></ul></li><li><a href=#%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE>通信协议</a></li><li><a href=#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B>运行时工作流程</a></li><li><a href=#%E5%A4%9A-agent-%E6%9E%B6%E6%9E%84>多 Agent 架构</a></li><li><a href=#%E5%AE%89%E5%85%A8%E6%A8%A1%E5%9E%8B>安全模型</a></li><li><a href=#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7>可扩展性</a></li><li><a href=#%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F>部署模式</a></li><li><a href=#cli-%E5%8F%82%E8%80%83>CLI 参考</a></li><li><a href=#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5>最佳实践</a></li><li><a href=#%E6%A0%B8%E5%BF%83%E8%A6%81%E7%82%B9>核心要点</a></li><li><a href=#%E6%9C%AA%E6%9D%A5%E8%B7%AF%E7%BA%BF%E5%9B%BE>未来路线图</a></li></ol><hr><h2 id=高层架构>高层架构<a hidden class=anchor aria-hidden=true href=#高层架构>#</a></h2><p>OpenClaw 采用<strong>以网关为中心的架构</strong>，由单个长期运行的进程管理所有渠道连接，并作为客户端、工具和自动化的控制平面。</p><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph TD
    subgraph Channels [消息渠道]
        WA[WhatsApp]
        TG[Telegram]
        DC[Discord]
        SL[Slack]
        IM[iMessage]
    end

    subgraph Gateway [OpenClaw Gateway 控制平面]
        direction TB
        Router[Agent 路由器]
        SessionMgr[会话管理器]
        ToolExec[工具执行器]
        Cron[定时调度器]
        Canvas[Canvas 主机]
        
        Router --- SessionMgr
        SessionMgr --- ToolExec
    end

    subgraph Clients [客户端与节点]
        CLI[CLI 命令行]
        App[macOS 菜单栏应用]
        Nodes[设备节点 iOS/Android]
    end

    Channels ==&gt; Gateway
    Gateway &lt;==&gt; Clients
    ToolExec -.-&gt; Sandbox[Docker 沙箱]
</code></pre><h3 id=核心设计原则>核心设计原则<a hidden class=anchor aria-hidden=true href=#核心设计原则>#</a></h3><ol><li><strong>单一事实来源</strong>：每台主机一个网关实例，独占所有渠道会话（这对 WhatsApp 的单会话限制尤为关键）</li><li><strong>默认本地回环</strong>：网关默认绑定至 <code>127.0.0.1:18789</code>，远程访问需显式配置</li><li><strong>协议优先</strong>：所有通信采用带 JSON Schema 验证的类型化 WebSocket 协议</li><li><strong>确定性路由</strong>：响应消息确定性地返回至来源渠道，无需模型参与路由决策</li><li><strong>本地优先</strong>：专为个人使用设计，会话状态持久化存储于本地</li></ol><hr><h2 id=核心组件>核心组件<a hidden class=anchor aria-hidden=true href=#核心组件>#</a></h2><h3 id=网关控制平面>网关（控制平面）<a hidden class=anchor aria-hidden=true href=#网关控制平面>#</a></h3><p>网关是 OpenClaw 的核心——一个 Node.js 进程，负责：</p><ul><li><strong>管理所有渠道连接</strong>（WhatsApp 通过 Baileys、Telegram 通过 grammY 等）</li><li><strong>暴露 WebSocket API</strong> 供客户端、自动化和设备节点使用</li><li><strong>路由消息</strong> 在渠道和 Agent 之间</li><li><strong>管理会话状态</strong> 和持久化</li><li><strong>执行工具</strong>（在主机或 Docker 沙箱中）</li></ul><h4 id=启动网关>启动网关<a hidden class=anchor aria-hidden=true href=#启动网关>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 基本启动</span>
</span></span><span style=display:flex><span>openclaw gateway --port <span style=color:#ae81ff>18789</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启用详细日志</span>
</span></span><span style=display:flex><span>openclaw gateway --port <span style=color:#ae81ff>18789</span> --verbose
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 强制终止现有监听并启动</span>
</span></span><span style=display:flex><span>openclaw gateway --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 开发模式（隔离状态）</span>
</span></span><span style=display:flex><span>openclaw --dev gateway --allow-unconfigured
</span></span></code></pre></div><h4 id=配置文件位置>配置文件位置<a hidden class=anchor aria-hidden=true href=#配置文件位置>#</a></h4><pre tabindex=0><code>~/.openclaw/openclaw.json   # 主配置（JSON5 格式）
~/.openclaw/workspace       # Agent 工作区
~/.openclaw/credentials     # 渠道凭证
~/.openclaw/agents/&lt;id&gt;     # 每个 Agent 的状态
</code></pre><h4 id=最小配置示例>最小配置示例<a hidden class=anchor aria-hidden=true href=#最小配置示例>#</a></h4><pre tabindex=0><code class=language-json5 data-lang=json5>// ~/.openclaw/openclaw.json
{
  agent: {
    model: &#34;anthropic/claude-opus-4-5&#34;
  },
  agents: {
    defaults: {
      workspace: &#34;~/.openclaw/workspace&#34;
    }
  },
  channels: {
    whatsapp: {
      dmPolicy: &#34;allowlist&#34;,
      allowFrom: [&#34;+15551234567&#34;]
    }
  }
}
</code></pre><p>网关支持通过文件系统监听实现配置热重载。默认模式（<code>gateway.reload.mode="hybrid"</code>）会热应用安全变更，并在关键变更时触发重启。</p><hr><h3 id=agent-运行时>Agent 运行时<a hidden class=anchor aria-hidden=true href=#agent-运行时>#</a></h3><p>OpenClaw 使用 <strong>Pi</strong> 作为其内嵌 Agent 运行时。Agent 循环处理：</p><ol><li>从渠道<strong>接收消息</strong></li><li><strong>组装上下文</strong>（系统提示、技能、会话历史）</li><li>通过配置的提供商进行<strong>模型推理</strong></li><li>带流式输出的<strong>工具执行</strong></li><li>将<strong>会话持久化</strong>至 JSONL 格式的记录文件</li></ol><h4 id=agent-循环生命周期>Agent 循环生命周期<a hidden class=anchor aria-hidden=true href=#agent-循环生命周期>#</a></h4><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    participant Ch as 渠道
    participant G as 网关
    participant A as Agent (Pi)
    participant M as 模型
    participant T as 工具/沙箱

    Ch-&gt;&gt;G: 接收入站消息
    G-&gt;&gt;G: 解析会话 &amp; 路由
    G-&gt;&gt;A: 启动 Agent 轮次
    A-&gt;&gt;M: 携带上下文进行推理
    M--&gt;&gt;A: 吐出思考流
    A--&gt;&gt;G: 实时流式转发给用户
    
    opt 工具调用
        M-&gt;&gt;A: 请求执行工具
        A-&gt;&gt;T: 执行命令
        T--&gt;&gt;A: 返回执行结果
        A-&gt;&gt;M: 将结果喂回模型
        M--&gt;&gt;A: 最终总结
    end

    A-&gt;&gt;G: 任务完成
    G-&gt;&gt;Ch: 发送最终响应
    G-&gt;&gt;G: 持久化会话记录
</code></pre><h4 id=关键事件类型>关键事件类型<a hidden class=anchor aria-hidden=true href=#关键事件类型>#</a></h4><table><thead><tr><th>流</th><th>用途</th></tr></thead><tbody><tr><td><code>lifecycle</code></td><td>阶段转换（<code>start</code>、<code>end</code>、<code>error</code>）</td></tr><tr><td><code>assistant</code></td><td>流式模型输出增量</td></tr><tr><td><code>tool</code></td><td>工具开始/更新/结束事件</td></tr><tr><td><code>compaction</code></td><td>会话压缩事件</td></tr></tbody></table><h4 id=并发控制>并发控制<a hidden class=anchor aria-hidden=true href=#并发控制>#</a></h4><p>每个会话的运行通过队列系统串行化。这可以防止工具/会话竞态条件，并保持历史记录一致性。消息渠道可配置队列模式：</p><ul><li><code>collect</code>：批量收集多条消息</li><li><code>steer</code>：优先级路由</li><li><code>followup</code>：链式响应</li></ul><hr><h3 id=会话>会话<a hidden class=anchor aria-hidden=true href=#会话>#</a></h3><p>会话跟踪用户与 Agent 之间的对话状态。OpenClaw 采用精细的会话模型：</p><h4 id=会话键结构>会话键结构<a hidden class=anchor aria-hidden=true href=#会话键结构>#</a></h4><pre tabindex=0><code># 私聊（默认：合并至主会话）
agent:&lt;agentId&gt;:&lt;mainKey&gt;

# 按对端隔离
agent:&lt;agentId&gt;:dm:&lt;peerId&gt;

# 按渠道-对端隔离
agent:&lt;agentId&gt;:&lt;channel&gt;:dm:&lt;peerId&gt;

# 群组（始终隔离）
agent:&lt;agentId&gt;:&lt;channel&gt;:group:&lt;groupId&gt;

# Telegram 论坛主题
agent:&lt;agentId&gt;:telegram:group:&lt;chatId&gt;:topic:&lt;threadId&gt;

# 自动化
cron:&lt;jobId&gt;
hook:&lt;uuid&gt;
</code></pre><h4 id=会话配置>会话配置<a hidden class=anchor aria-hidden=true href=#会话配置>#</a></h4><pre tabindex=0><code class=language-json5 data-lang=json5>{
  session: {
    // 私聊分组方式
    dmScope: &#34;main&#34;,        // 选项：main, per-peer, per-channel-peer

    // 重置策略
    reset: {
      mode: &#34;daily&#34;,
      atHour: 4,            // 本地时间凌晨 4 点
      idleMinutes: 120      // 或基于空闲时间
    },

    // 按类型覆盖
    resetByType: {
      dm: { mode: &#34;idle&#34;, idleMinutes: 240 },
      group: { mode: &#34;daily&#34;, atHour: 4 }
    },

    // 身份关联（跨渠道识别同一用户）
    identityLinks: {
      alice: [&#34;telegram:123456789&#34;, &#34;discord:987654321012345678&#34;]
    }
  }
}
</code></pre><h4 id=存储布局>存储布局<a hidden class=anchor aria-hidden=true href=#存储布局>#</a></h4><pre tabindex=0><code>~/.openclaw/agents/&lt;agentId&gt;/
├── sessions/
│   ├── sessions.json           # 会话元数据存储
│   ├── &lt;sessionId&gt;.jsonl       # 记录日志
│   └── &lt;sessionId&gt;-topic-&lt;threadId&gt;.jsonl
└── agent/
    └── auth-profiles.json      # 每个 Agent 的模型凭证
</code></pre><hr><h3 id=渠道>渠道<a hidden class=anchor aria-hidden=true href=#渠道>#</a></h3><p>渠道是 OpenClaw 连接的消息平台。每个渠道都有独立的适配器：</p><table><thead><tr><th>渠道</th><th>库</th><th>特性</th></tr></thead><tbody><tr><td>WhatsApp</td><td>Baileys</td><td>Web 协议、多账号、媒体</td></tr><tr><td>Telegram</td><td>grammY</td><td>Bot API、Webhooks、群组、主题</td></tr><tr><td>Discord</td><td>discord.js</td><td>服务器、私聊、帖子</td></tr><tr><td>Slack</td><td>Bolt</td><td>工作区、频道、帖子</td></tr><tr><td>Signal</td><td>signal-cli</td><td>端到端加密</td></tr><tr><td>iMessage</td><td>imsg (macOS)</td><td>原生 macOS 集成</td></tr><tr><td>WebChat</td><td>内置</td><td>基于浏览器的界面</td></tr></tbody></table><h4 id=渠道配置模式>渠道配置模式<a hidden class=anchor aria-hidden=true href=#渠道配置模式>#</a></h4><pre tabindex=0><code class=language-json5 data-lang=json5>{
  channels: {
    whatsapp: {
      enabled: true,
      dmPolicy: &#34;pairing&#34;,        // pairing, allowlist, open
      allowFrom: [&#34;+15551234567&#34;],
      groups: {
        &#34;*&#34;: { requireMention: true }
      }
    },
    telegram: {
      enabled: true,
      botToken: &#34;${TELEGRAM_BOT_TOKEN}&#34;,
      dmPolicy: &#34;pairing&#34;,
      groups: {
        &#34;*&#34;: { requireMention: true }
      }
    }
  }
}
</code></pre><h4 id=私聊策略>私聊策略<a hidden class=anchor aria-hidden=true href=#私聊策略>#</a></h4><table><thead><tr><th>策略</th><th>行为</th></tr></thead><tbody><tr><td><code>pairing</code></td><td>未知发送者将收到配对码以供审批</td></tr><tr><td><code>allowlist</code></td><td>仅 <code>allowFrom</code> 中的号码/ID 可发送消息</td></tr><tr><td><code>open</code></td><td>任何人都可发送消息（对工具执行存在风险！）</td></tr></tbody></table><hr><h3 id=技能>技能<a hidden class=anchor aria-hidden=true href=#技能>#</a></h3><p>技能教会 Agent 如何使用工具。OpenClaw 采用与 <a href=https://agentskills.io>AgentSkills</a> 兼容的格式：</p><h4 id=技能结构>技能结构<a hidden class=anchor aria-hidden=true href=#技能结构>#</a></h4><pre tabindex=0><code>skills/
└── my-skill/
    └── SKILL.md
</code></pre><h4 id=skillmd-格式>SKILL.md 格式<a hidden class=anchor aria-hidden=true href=#skillmd-格式>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-markdown data-lang=markdown><span style=display:flex><span>---
</span></span><span style=display:flex><span>name: weather
</span></span><span style=display:flex><span>description: 获取指定位置的天气预报
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 使用方法
</span></span></span><span style=display:flex><span>使用 <span style=color:#e6db74>`weather`</span> 命令获取当前天气状况和预报。
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## 示例
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`weather &#34;San Francisco, CA&#34;`</span>
</span></span></code></pre></div><h4 id=技能优先级>技能优先级<a hidden class=anchor aria-hidden=true href=#技能优先级>#</a></h4><ol><li><strong>工作区技能</strong>：<code>&lt;workspace>/skills</code>（最高优先级）</li><li><strong>托管技能</strong>：<code>~/.openclaw/skills</code></li><li><strong>内置技能</strong>：随 OpenClaw 一起发布（最低优先级）</li></ol><h4 id=技能门控>技能门控<a hidden class=anchor aria-hidden=true href=#技能门控>#</a></h4><p>技能可根据环境、二进制文件或配置条件加载：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># SKILL.md frontmatter</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>macos-only-skill</span>
</span></span><span style=display:flex><span><span style=color:#f92672>description</span>: <span style=color:#ae81ff>需要 macOS 环境</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>: {<span style=color:#e6db74>&#34;openclaw&#34;</span>:{<span style=color:#e6db74>&#34;requires&#34;</span>:{<span style=color:#e6db74>&#34;platform&#34;</span>:<span style=color:#e6db74>&#34;darwin&#34;</span>,<span style=color:#e6db74>&#34;bins&#34;</span>:[<span style=color:#e6db74>&#34;swift&#34;</span>]}}}
</span></span><span style=display:flex><span>---
</span></span></code></pre></div><hr><h3 id=节点>节点<a hidden class=anchor aria-hidden=true href=#节点>#</a></h3><p>节点是连接到网关的远程设备（macOS、iOS、Android），用于执行设备本地操作：</p><h4 id=节点能力>节点能力<a hidden class=anchor aria-hidden=true href=#节点能力>#</a></h4><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td><code>canvas.*</code></td><td>渲染 Agent 驱动的 UI</td></tr><tr><td><code>camera.*</code></td><td>拍照、录制视频</td></tr><tr><td><code>screen.record</code></td><td>屏幕录制</td></tr><tr><td><code>location.get</code></td><td>获取设备位置</td></tr><tr><td><code>system.notify</code></td><td>推送通知</td></tr><tr><td><code>system.run</code></td><td>执行命令（macOS）</td></tr></tbody></table><h4 id=节点架构>节点架构<a hidden class=anchor aria-hidden=true href=#节点架构>#</a></h4><pre tabindex=0><code>┌────────────────┐     WebSocket      ┌──────────────┐
│      网关      │◄──────────────────►│  macOS 节点  │
│                │                    │  - 相机      │
│  node.invoke   │                    │  - 屏幕      │
│  node.list     │                    │  - 位置      │
│  node.describe │                    │  - system.*  │
└────────────────┘                    └──────────────┘
        ▲
        │
        ▼
┌────────────────┐
│   iOS 节点     │
│   - Canvas     │
│   - 相机       │
│   - 语音       │
└────────────────┘
</code></pre><h4 id=节点配对流程>节点配对流程<a hidden class=anchor aria-hidden=true href=#节点配对流程>#</a></h4><ol><li>节点在 <code>connect</code> 帧中携带 <code>role: "node"</code> 进行连接</li><li>网关为未识别的设备返回配对码</li><li>操作员审批：<code>openclaw pairing approve &lt;code></code></li><li>节点收到设备令牌，用于后续连接</li></ol><hr><h2 id=通信协议>通信协议<a hidden class=anchor aria-hidden=true href=#通信协议>#</a></h2><p>OpenClaw 使用带强制握手的类型化 WebSocket 协议：</p><h3 id=连接生命周期>连接生命周期<a hidden class=anchor aria-hidden=true href=#连接生命周期>#</a></h3><pre tabindex=0><code>客户端                          网关
  │                                │
  │── req:connect ────────────────►│
  │                                │  (验证认证、能力)
  │◄────────── res:hello-ok ───────│
  │                                │
  │◄────────── event:presence ─────│
  │◄────────── event:tick ─────────│
  │                                │
  │── req:agent ──────────────────►│
  │◄────────── res:ack ────────────│  (runId, status:accepted)
  │◄────────── event:agent ────────│  (流式传输)
  │◄────────── res:agent ──────────│  (最终：status, summary)
  │                                │
</code></pre><h3 id=消息类型>消息类型<a hidden class=anchor aria-hidden=true href=#消息类型>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// 请求
</span></span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;req&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>method</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>params</span>: <span style=color:#66d9ef>object</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 响应
</span></span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;res&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ok</span>: <span style=color:#66d9ef>boolean</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>payload?</span>: <span style=color:#66d9ef>object</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>error?</span>: <span style=color:#66d9ef>object</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 事件
</span></span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;event&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>object</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>seq?</span>: <span style=color:#66d9ef>number</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stateVersion?</span>: <span style=color:#66d9ef>number</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=核心方法>核心方法<a hidden class=anchor aria-hidden=true href=#核心方法>#</a></h3><table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td><code>connect</code></td><td>强制首帧，建立会话</td></tr><tr><td><code>agent</code></td><td>运行一轮 Agent</td></tr><tr><td><code>agent.wait</code></td><td>等待 Agent 完成</td></tr><tr><td><code>send</code></td><td>通过活动渠道发送消息</td></tr><tr><td><code>health</code></td><td>完整健康快照</td></tr><tr><td><code>status</code></td><td>简短摘要</td></tr><tr><td><code>node.list</code></td><td>列出已连接/已配对的节点</td></tr><tr><td><code>node.invoke</code></td><td>执行节点命令</td></tr><tr><td><code>config.patch</code></td><td>部分配置更新 + 重启</td></tr></tbody></table><h3 id=认证>认证<a hidden class=anchor aria-hidden=true href=#认证>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>// 带认证的连接帧
{
  type: &#34;req&#34;,
  id: &#34;1&#34;,
  method: &#34;connect&#34;,
  params: {
    minProtocol: 1,
    maxProtocol: 1,
    client: {
      id: &#34;my-client-id&#34;,
      version: &#34;1.0.0&#34;,
      platform: &#34;macos&#34;
    },
    auth: {
      token: &#34;${OPENCLAW_GATEWAY_TOKEN}&#34;  // 非本地回环连接必需
    }
  }
}
</code></pre><hr><h2 id=运行时工作流程>运行时工作流程<a hidden class=anchor aria-hidden=true href=#运行时工作流程>#</a></h2><p><img alt=路由 loading=lazy src=https://Lumicreator.github.io/lumi-tech-blog/openclaw-internal-routing.png></p><h3 id=消息流从接收到响应>消息流：从接收到响应<a hidden class=anchor aria-hidden=true href=#消息流从接收到响应>#</a></h3><pre tabindex=0><code>1. 消息接收（WhatsApp/Telegram 等）
         │
         ▼
2. 渠道适配器规范化信封
   - 提取发送者、内容、媒体、回复上下文
         │
         ▼
3. 路由确定 Agent 和会话
   - 检查多 Agent 绑定
   - 应用私聊策略（pairing/allowlist/open）
   - 构建会话键
         │
         ▼
4. 会话管理器加载/创建会话
   - 检查重置策略（daily/idle）
   - 加载现有记录（如存在）
         │
         ▼
5. Agent 循环执行
   - 组装系统提示 + 技能
   - 携带上下文调用模型
   - 按需执行工具
   - 流式输出助手响应
         │
         ▼
6. 响应路由发送回复
   - 确定性：返回源渠道
   - 按平台限制分块
   - 处理媒体附件
         │
         ▼
7. 会话持久化记录至 JSONL
</code></pre><h3 id=工具执行流程>工具执行流程<a hidden class=anchor aria-hidden=true href=#工具执行流程>#</a></h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>stateDiagram-v2
    [*] --&gt; Request: 模型发起工具调用
    Request --&gt; SandboxCheck: 检查沙箱模式
    
    state SandboxCheck {
        direction LR
        Host: 在宿主机运行
        Docker: 在 Docker 沙箱运行
    }
    
    SandboxCheck --&gt; Host: mode=&#34;off&#34;
    SandboxCheck --&gt; Docker: mode=&#34;all&#34; | mode=&#34;non-main&#34;
    
    Host --&gt; Sanitize: 获取执行结果
    Docker --&gt; Sanitize: 获取执行结果
    
    Sanitize --&gt; Stream: 脱敏并实时推流
    Stream --&gt; [*]: 完成并喂回模型
</code></pre><hr><h2 id=多-agent-架构>多 Agent 架构<a hidden class=anchor aria-hidden=true href=#多-agent-架构>#</a></h2><p>OpenClaw 支持在单个网关内运行多个隔离的 Agent：</p><h3 id=agent-隔离>Agent 隔离<a hidden class=anchor aria-hidden=true href=#agent-隔离>#</a></h3><p>每个 Agent 拥有：</p><ul><li><strong>独立工作区</strong>（文件、AGENTS.md、SOUL.md、USER.md）</li><li><strong>独立状态目录</strong>（<code>~/.openclaw/agents/&lt;agentId></code>）</li><li><strong>独立会话存储</strong></li><li><strong>独立认证配置</strong>（模型凭证）</li></ul><h3 id=绑定配置>绑定配置<a hidden class=anchor aria-hidden=true href=#绑定配置>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>{
  agents: {
    list: [
      {
        id: &#34;personal&#34;,
        workspace: &#34;~/.openclaw/workspace-personal&#34;,
        default: true
      },
      {
        id: &#34;work&#34;,
        workspace: &#34;~/.openclaw/workspace-work&#34;
      }
    ]
  },
  bindings: [
    // 将特定私聊路由至工作 Agent
    {
      agentId: &#34;work&#34;,
      match: {
        channel: &#34;telegram&#34;,
        peer: { kind: &#34;dm&#34;, id: &#34;123456789&#34; }
      }
    },
    // 将 Discord 服务器路由至工作 Agent
    {
      agentId: &#34;work&#34;,
      match: {
        channel: &#34;discord&#34;,
        guildId: &#34;987654321&#34;
      }
    }
    // 其他流量回落至默认（personal）
  ]
}
</code></pre><h3 id=绑定解析顺序>绑定解析顺序<a hidden class=anchor aria-hidden=true href=#绑定解析顺序>#</a></h3><ol><li>精确对端匹配（私聊/群组/频道 ID）</li><li>服务器 ID（Discord）</li><li>团队 ID（Slack）</li><li>渠道账号 ID</li><li>渠道级匹配</li><li>默认 Agent</li></ol><hr><h2 id=安全模型>安全模型<a hidden class=anchor aria-hidden=true href=#安全模型>#</a></h2><h3 id=威胁模型>威胁模型<a hidden class=anchor aria-hidden=true href=#威胁模型>#</a></h3><p>运行具有 Shell 访问权限的 AI 助手需要谨慎的安全设计：</p><pre tabindex=0><code>┌────────────────────────────────────────────────────────────┐
│                    威胁面                                   │
│                                                             │
│  入站攻击                                                   │
│  - 消息中的提示注入                                         │
│  - 通过私聊进行社会工程                                     │
│  - 恶意群组成员                                             │
│                                                             │
│  影响范围                                                   │
│  - Shell 命令执行                                           │
│  - 文件系统访问                                             │
│  - 网络访问                                                 │
│  - 凭证暴露                                                 │
└────────────────────────────────────────────────────────────┘
</code></pre><h3 id=防御层级>防御层级<a hidden class=anchor aria-hidden=true href=#防御层级>#</a></h3><ol><li><strong>身份优先</strong>：控制谁可以与机器人对话</li><li><strong>范围次之</strong>：限制机器人的操作范围</li><li><strong>沙箱隔离</strong>：隔离工具执行环境</li><li><strong>工具策略</strong>：允许/拒绝特定工具</li></ol><h3 id=安全审计>安全审计<a hidden class=anchor aria-hidden=true href=#安全审计>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 运行安全审计</span>
</span></span><span style=display:flex><span>openclaw security audit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 深度审计（包含实时探测）</span>
</span></span><span style=display:flex><span>openclaw security audit --deep
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 自动修复常见问题</span>
</span></span><span style=display:flex><span>openclaw security audit --fix
</span></span></code></pre></div><h3 id=沙箱配置>沙箱配置<a hidden class=anchor aria-hidden=true href=#沙箱配置>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>{
  agents: {
    defaults: {
      sandbox: {
        mode: &#34;non-main&#34;,           // off, non-main, all
        scope: &#34;session&#34;,           // session, agent, shared
        workspaceAccess: &#34;none&#34;,    // none, ro, rw
        docker: {
          network: &#34;none&#34;,          // 禁用网络
          binds: [                  // 自定义挂载
            &#34;/data/shared:/data:ro&#34;
          ]
        }
      }
    }
  }
}
</code></pre><h3 id=凭证存储>凭证存储<a hidden class=anchor aria-hidden=true href=#凭证存储>#</a></h3><table><thead><tr><th>凭证</th><th>位置</th></tr></thead><tbody><tr><td>WhatsApp 凭证</td><td><code>~/.openclaw/credentials/whatsapp/&lt;accountId>/creds.json</code></td></tr><tr><td>Telegram 令牌</td><td>配置文件或环境变量</td></tr><tr><td>模型认证</td><td><code>~/.openclaw/agents/&lt;agentId>/agent/auth-profiles.json</code></td></tr><tr><td>配对白名单</td><td><code>~/.openclaw/credentials/&lt;channel>-allowFrom.json</code></td></tr></tbody></table><hr><h2 id=可扩展性>可扩展性<a hidden class=anchor aria-hidden=true href=#可扩展性>#</a></h2><h3 id=插件系统>插件系统<a hidden class=anchor aria-hidden=true href=#插件系统>#</a></h3><p>插件通过新渠道、工具和技能扩展 OpenClaw：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 列出插件</span>
</span></span><span style=display:flex><span>openclaw plugins list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安装插件</span>
</span></span><span style=display:flex><span>openclaw plugins install &lt;plugin&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 启用/禁用</span>
</span></span><span style=display:flex><span>openclaw plugins enable &lt;plugin&gt;
</span></span><span style=display:flex><span>openclaw plugins disable &lt;plugin&gt;
</span></span></code></pre></div><h3 id=插件钩子>插件钩子<a hidden class=anchor aria-hidden=true href=#插件钩子>#</a></h3><table><thead><tr><th>钩子</th><th>时机</th></tr></thead><tbody><tr><td><code>before_agent_start</code></td><td>Agent 轮次开始前</td></tr><tr><td><code>agent_end</code></td><td>Agent 完成后</td></tr><tr><td><code>before_tool_call</code></td><td>工具执行前</td></tr><tr><td><code>after_tool_call</code></td><td>工具执行后</td></tr><tr><td><code>message_received</code></td><td>接收入站消息</td></tr><tr><td><code>message_sending</code></td><td>发送前</td></tr><tr><td><code>gateway_start</code></td><td>网关启动</td></tr></tbody></table><h3 id=clawdhub技能注册中心>ClawdHub（技能注册中心）<a hidden class=anchor aria-hidden=true href=#clawdhub技能注册中心>#</a></h3><p><a href=https://clawdhub.com>ClawdHub</a> 提供技能发现和安装：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装技能</span>
</span></span><span style=display:flex><span>clawdhub install weather
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 更新所有技能</span>
</span></span><span style=display:flex><span>clawdhub update --all
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 同步本地技能至注册中心</span>
</span></span><span style=display:flex><span>clawdhub sync --all
</span></span></code></pre></div><hr><h2 id=部署模式>部署模式<a hidden class=anchor aria-hidden=true href=#部署模式>#</a></h2><h3 id=模式-1本地开发>模式 1：本地开发<a hidden class=anchor aria-hidden=true href=#模式-1本地开发>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 快速开始</span>
</span></span><span style=display:flex><span>npm install -g openclaw@latest
</span></span><span style=display:flex><span>openclaw onboard --install-daemon
</span></span><span style=display:flex><span>openclaw channels login        <span style=color:#75715e># WhatsApp 扫码</span>
</span></span><span style=display:flex><span>openclaw gateway
</span></span></code></pre></div><h3 id=模式-2远程-linux-服务器>模式 2：远程 Linux 服务器<a hidden class=anchor aria-hidden=true href=#模式-2远程-linux-服务器>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 在服务器上</span>
</span></span><span style=display:flex><span>npm install -g openclaw@latest
</span></span><span style=display:flex><span>openclaw onboard --install-daemon
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 通过 SSH 隧道访问</span>
</span></span><span style=display:flex><span>ssh -N -L 18789:127.0.0.1:18789 user@server
</span></span></code></pre></div><h3 id=模式-3docker-部署>模式 3：Docker 部署<a hidden class=anchor aria-hidden=true href=#模式-3docker-部署>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 构建和设置</span>
</span></span><span style=display:flex><span>./docker-setup.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 手动 compose</span>
</span></span><span style=display:flex><span>docker build -t openclaw:local -f Dockerfile .
</span></span><span style=display:flex><span>docker compose run --rm openclaw-cli onboard
</span></span><span style=display:flex><span>docker compose up -d openclaw-gateway
</span></span></code></pre></div><h3 id=模式-4tailscale-暴露>模式 4：Tailscale 暴露<a hidden class=anchor aria-hidden=true href=#模式-4tailscale-暴露>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>{
  gateway: {
    tailscale: {
      mode: &#34;serve&#34;,         // serve（内网）或 funnel（公网）
      resetOnExit: true
    },
    auth: {
      mode: &#34;password&#34;,      // funnel 必需
      password: &#34;${OPENCLAW_GATEWAY_PASSWORD}&#34;
    }
  }
}
</code></pre><h3 id=模式-5多-agent-服务器>模式 5：多 Agent 服务器<a hidden class=anchor aria-hidden=true href=#模式-5多-agent-服务器>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>{
  agents: {
    list: [
      { id: &#34;alice&#34;, workspace: &#34;~/.openclaw/workspace-alice&#34; },
      { id: &#34;bob&#34;, workspace: &#34;~/.openclaw/workspace-bob&#34; }
    ]
  },
  channels: {
    whatsapp: {
      accounts: [
        { id: &#34;alice-wa&#34;, name: &#34;Alice&#34; },
        { id: &#34;bob-wa&#34;, name: &#34;Bob&#34; }
      ]
    }
  },
  bindings: [
    { agentId: &#34;alice&#34;, match: { channel: &#34;whatsapp&#34;, accountId: &#34;alice-wa&#34; } },
    { agentId: &#34;bob&#34;, match: { channel: &#34;whatsapp&#34;, accountId: &#34;bob-wa&#34; } }
  ]
}
</code></pre><hr><h2 id=cli-参考>CLI 参考<a hidden class=anchor aria-hidden=true href=#cli-参考>#</a></h2><h3 id=常用命令>常用命令<a hidden class=anchor aria-hidden=true href=#常用命令>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置与配置</span>
</span></span><span style=display:flex><span>openclaw onboard              <span style=color:#75715e># 交互式向导</span>
</span></span><span style=display:flex><span>openclaw setup                <span style=color:#75715e># 初始化配置</span>
</span></span><span style=display:flex><span>openclaw configure            <span style=color:#75715e># 设置凭证</span>
</span></span><span style=display:flex><span>openclaw doctor               <span style=color:#75715e># 健康检查 + 修复</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 网关控制</span>
</span></span><span style=display:flex><span>openclaw gateway status       <span style=color:#75715e># 检查网关状态</span>
</span></span><span style=display:flex><span>openclaw gateway start        <span style=color:#75715e># 作为服务启动</span>
</span></span><span style=display:flex><span>openclaw gateway stop         <span style=color:#75715e># 停止服务</span>
</span></span><span style=display:flex><span>openclaw gateway restart      <span style=color:#75715e># 重启服务</span>
</span></span><span style=display:flex><span>openclaw gateway --port <span style=color:#ae81ff>18789</span> <span style=color:#75715e># 前台运行</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 消息</span>
</span></span><span style=display:flex><span>openclaw message send --target +1234567890 --message <span style=color:#e6db74>&#34;Hello&#34;</span>
</span></span><span style=display:flex><span>openclaw agent --message <span style=color:#e6db74>&#34;今天天气怎么样？&#34;</span> --thinking high
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 会话</span>
</span></span><span style=display:flex><span>openclaw sessions             <span style=color:#75715e># 列出会话</span>
</span></span><span style=display:flex><span>openclaw sessions --json      <span style=color:#75715e># JSON 输出</span>
</span></span><span style=display:flex><span>openclaw status               <span style=color:#75715e># 快速健康检查</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 渠道</span>
</span></span><span style=display:flex><span>openclaw channels list        <span style=color:#75715e># 列出已配置渠道</span>
</span></span><span style=display:flex><span>openclaw channels login       <span style=color:#75715e># 关联 WhatsApp 等</span>
</span></span><span style=display:flex><span>openclaw channels status      <span style=color:#75715e># 渠道健康状况</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 技能</span>
</span></span><span style=display:flex><span>openclaw skills list          <span style=color:#75715e># 列出已加载技能</span>
</span></span><span style=display:flex><span>openclaw skills info &lt;name&gt;   <span style=color:#75715e># 技能详情</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 安全</span>
</span></span><span style=display:flex><span>openclaw security audit       <span style=color:#75715e># 运行安全审计</span>
</span></span></code></pre></div><h3 id=应用内聊天命令>应用内聊天命令<a hidden class=anchor aria-hidden=true href=#应用内聊天命令>#</a></h3><table><thead><tr><th>命令</th><th>操作</th></tr></thead><tbody><tr><td><code>/status</code></td><td>会话状态、token 数、模型</td></tr><tr><td><code>/new</code> 或 <code>/reset</code></td><td>重置会话</td></tr><tr><td><code>/new &lt;model></code></td><td>使用新模型重置</td></tr><tr><td><code>/compact</code></td><td>压缩旧上下文</td></tr><tr><td><code>/think &lt;level></code></td><td>设置思考级别</td></tr><tr><td><code>/stop</code></td><td>中止当前运行</td></tr><tr><td><code>/context list</code></td><td>显示上下文来源</td></tr><tr><td><code>/send on/off</code></td><td>切换消息发送</td></tr></tbody></table><hr><h2 id=最佳实践>最佳实践<a hidden class=anchor aria-hidden=true href=#最佳实践>#</a></h2><h3 id=1-安全优先>1. 安全优先<a hidden class=anchor aria-hidden=true href=#1-安全优先>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>{
  channels: {
    whatsapp: {
      dmPolicy: &#34;pairing&#34;,           // 切勿使用 &#34;open&#34;！
      groups: { &#34;*&#34;: { requireMention: true } }
    }
  },
  agents: {
    defaults: {
      sandbox: { mode: &#34;non-main&#34; }  // 群组使用沙箱
    }
  }
}
</code></pre><h3 id=2-使用专用手机号>2. 使用专用手机号<a hidden class=anchor aria-hidden=true href=#2-使用专用手机号>#</a></h3><p>对于 WhatsApp，建议使用独立号码以避免自聊天的异常行为，并保持路由清晰。</p><h3 id=3-工作区组织>3. 工作区组织<a hidden class=anchor aria-hidden=true href=#3-工作区组织>#</a></h3><pre tabindex=0><code>~/.openclaw/workspace/
├── AGENTS.md           # Agent 指令
├── SOUL.md             # 人格定义
├── USER.md             # 用户上下文
├── TOOLS.md            # 环境特定笔记
├── memory/
│   └── YYYY-MM-DD.md   # 每日日志
├── skills/
│   └── custom-skill/
│       └── SKILL.md
└── canvas/
    └── index.html      # Canvas 内容
</code></pre><h3 id=4-模型选择>4. 模型选择<a hidden class=anchor aria-hidden=true href=#4-模型选择>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>{
  agent: {
    model: &#34;anthropic/claude-opus-4-5&#34;,  // 强大的长上下文能力
    thinkingLevel: &#34;low&#34;                 // 平衡速度与质量
  }
}
</code></pre><h3 id=5-会话重置策略>5. 会话重置策略<a hidden class=anchor aria-hidden=true href=#5-会话重置策略>#</a></h3><pre tabindex=0><code class=language-json5 data-lang=json5>{
  session: {
    reset: {
      mode: &#34;daily&#34;,
      atHour: 4         // 每天早晨全新开始
    },
    resetByType: {
      group: { mode: &#34;idle&#34;, idleMinutes: 120 }  // 群组更快重置
    }
  }
}
</code></pre><h3 id=6-监控>6. 监控<a hidden class=anchor aria-hidden=true href=#6-监控>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 定期检查健康状况</span>
</span></span><span style=display:flex><span>openclaw health
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 监控日志</span>
</span></span><span style=display:flex><span>openclaw logs --follow
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 定期运行审计</span>
</span></span><span style=display:flex><span>openclaw doctor
</span></span><span style=display:flex><span>openclaw security audit
</span></span></code></pre></div><hr><h2 id=核心要点>核心要点<a hidden class=anchor aria-hidden=true href=#核心要点>#</a></h2><ol><li><p><strong>以网关为中心的设计</strong>：单一进程管理所有渠道连接，实现确定性路由和一致的状态管理。</p></li><li><p><strong>协议优先通信</strong>：带 JSON Schema 验证的类型化 WebSocket 协议确保可靠的客户端-服务器交互。</p></li><li><p><strong>分层安全</strong>：身份控制 → 范围限制 → 沙箱隔离 → 工具策略，提供纵深防御。</p></li><li><p><strong>灵活的多 Agent</strong>：绑定机制将消息路由至隔离的 Agent，支持在共享基础设施上运行多个用户或角色。</p></li><li><p><strong>可扩展架构</strong>：技能、插件和钩子支持在不修改核心代码的情况下进行定制。</p></li><li><p><strong>生产就绪运维</strong>：systemd/launchd 集成、热重载、健康检查和安全审计支持可靠部署。</p></li></ol><hr><h2 id=未来路线图>未来路线图<a hidden class=anchor aria-hidden=true href=#未来路线图>#</a></h2><p>基于当前开发模式和文档，潜在的演进方向包括：</p><h3 id=近期>近期<a hidden class=anchor aria-hidden=true href=#近期>#</a></h3><ul><li><strong>增强 MCP 支持</strong>：更深入的模型上下文协议集成</li><li><strong>语音通话技能</strong>：实时语音对话支持</li><li><strong>改进沙箱浏览器</strong>：沙箱环境中更好的浏览器自动化</li></ul><h3 id=中期>中期<a hidden class=anchor aria-hidden=true href=#中期>#</a></h3><ul><li><strong>联邦</strong>：跨网关 Agent 通信</li><li><strong>插件市场</strong>：策划的插件生态系统</li><li><strong>企业功能</strong>：SSO、审计日志、合规工具</li></ul><h3 id=长期>长期<a hidden class=anchor aria-hidden=true href=#长期>#</a></h3><ul><li><strong>分布式网关</strong>：多节点网关实现高可用</li><li><strong>微调集成</strong>：自定义模型训练工作流</li><li><strong>Agent 间协议</strong>：标准化的多 Agent 协作</li></ul><hr><h2 id=结语>结语<a hidden class=anchor aria-hidden=true href=#结语>#</a></h2><p>OpenClaw 代表了一种精心设计的个人 AI 助手方案——优先考虑本地控制、安全性和可扩展性。其以网关为中心的架构为将 LLM 与真实世界消息系统集成提供了坚实基础，同时保持了运维的简洁性。</p><p>对于构建生产级 AI 助手基础设施的开发者而言，OpenClaw 提供了宝贵的模式：协议驱动的通信、纵深防御的安全性，以及渠道、Agent 和工具之间的清晰分离。</p><p><strong>开始使用</strong>：<a href=https://github.com/openclaw/openclaw>github.com/openclaw/openclaw</a></p><p><strong>文档</strong>：<a href=https://docs.openclaw.ai>docs.openclaw.ai</a></p><p><strong>社区</strong>：<a href=https://discord.gg/clawd>Discord</a></p><hr><p><em>本文通过分析 OpenClaw 代码仓库（项目根目录）和 <code>https://github.com/openclaw/openclaw</code>（版本 2026.1.29）生成。</em></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://Lumicreator.github.io/lumi-tech-blog/tags/ai/>AI</a></li><li><a href=https://Lumicreator.github.io/lumi-tech-blog/tags/openclaw/>OpenClaw</a></li><li><a href=https://Lumicreator.github.io/lumi-tech-blog/tags/architecture/>Architecture</a></li><li><a href=https://Lumicreator.github.io/lumi-tech-blog/tags/gateway/>Gateway</a></li></ul><nav class=paginav><a class=prev href=https://Lumicreator.github.io/lumi-tech-blog/posts/openclaw-protocol/><span class=title>« Prev</span><br><span>OpenClaw 协议篇：揭秘网关与 AI 的“灵魂通信”</span>
</a><a class=next href=https://Lumicreator.github.io/lumi-tech-blog/posts/vpn-tutorial/><span class=title>Next »</span><br><span>保姆级 VLESS + Reality & CDN 加速全指南</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://Lumicreator.github.io/lumi-tech-blog/>Lumi's Tech Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script type=module>
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
mermaid.initialize({ startOnLoad: true, theme: 'default' });
</script><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>